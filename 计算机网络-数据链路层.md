# 数据链路层

# 一、主要功能

## 1. 封装成帧
* 将网络层传下来的IP数据报封装成帧；
* 给分组添加首部和尾部，用于标记帧的开始和结束；
* 网络层的IP数据包传送到数据链路层成为帧的数据部分；
* 帧： 点对点信道的数据链路层的协议数据单元；
* 帧定界： 开始符SOH，结束符EOT；
![Screenshot 2020-06-18 at 13.07.37](media/15924563355418/Screenshot%202020-06-18%20at%2013.07.37.png)

## 2. 透明传输
* 无论什么样的比特组合的数据，都能够按照原样没有差错的通过这个数据链路层；
* 透明表示一个实际存在的事物就好像不存在一样；
* 帧使用首部SOH和尾部EOT进行定界；
* 如果帧的数据部分（网络层传下来的IP数据报含有和首部尾部相同的内容，那么帧的开始和结束就会被错误判定；
* 需要在数据部分出现首部尾部相同的内容前面插入转义字符；
* 如果数据部分出现转义字符，那么就在转义字符前再加一个转义字符；
* 这个过程透明传输的内容是转义字符，用户察觉不到转义字符的存在；
* 转义字符ESC；
* 十六进制：SOH-01, EOT-04, ESC-1B；
![Screenshot 2020-06-18 at 13.11.53](media/15924563355418/Screenshot%202020-06-18%20at%2013.11.53.png)

## 3. 差错检测
* 使用循环冗余检测（CRC）来检查比特差错；
* 如果只用CRC只能做到对帧的无差错接受，但帧丢失、重复、失序也可能发生，属于出现传输差错；
* 无比特差错与无传输差错非同一概念，增加了帧编号、确认、重传机制；

# 二、信道分类
## 1. 广播信道
* 一对多通信，一个节点发送的数据能够被广播信道上所有的节点接收到；
* 所有的节点都在同一个广播信道上发送数据，因此需要有专门的控制方法进行协调，避免发生冲突（碰撞）；
* 主要有两种控制方法进行协调： [信道复用技术](#三、信道复用技术)、[CSMA/CD协议](#四、CSMA/CD协议)；

## 2. 点对点信道
* 一对一信道，不会发生碰撞，所以比较简单；
* 使用[PPP协议](#五、PPP协议)进行控制；

# 三、信道复用技术
## 1. 频分复用FDM
* 用户在分配到一定的频带后， 在通信过程中自始自终占用这个频带；
* 所有用户在同样的时间占用不同的频率带宽资源；
![Screenshot 2020-06-18 at 13.23.44](media/15924563355418/Screenshot%202020-06-18%20at%2013.23.44.png)


## 2. 时分复用TDM
* 将时间划分为一段段等长的时分复用帧；
* 所有用户是在不同的时间占用同样的频带宽度；
![Screenshot 2020-06-18 at 13.24.16](media/15924563355418/Screenshot%202020-06-18%20at%2013.24.16.png)

## 3. 统计时分复用
* 对时分复用的一种改进，不固定每个用户在时分复用帧中的位置；
* 只要有数据就集中起来组成统计时分复用帧然后发送；
![Screenshot 2020-06-18 at 13.26.58](media/15924563355418/Screenshot%202020-06-18%20at%2013.26.58.png)

## 4. 波分复用
* 光的频分复用；
* 由于光频率很高，因此习惯上用波长而不是频率来表示所使用的光载波儿；

## 5. 码分复用CDM
* 每一个比特时间再划分为m个短的间隔，称为码片；
* m通常为64/128；
* 码分复用需要发送的数据量为原先的m倍；
![Screenshot 2020-06-18 at 13.29.03](media/15924563355418/Screenshot%202020-06-18%20at%2013.29.03.png)
* 当接收端使用码片对接收到的数据进行内积运算时，结果为 0 的是其它用户发送的数据，结果为 1 的是用户发送的比特 1，结果为 -1 的是用户发送的比特 0；
* ![IMG_9737](media/15924563355418/IMG_9737.jpg)


## Tips
* 频分复用和时分复用，在通信的过程中，主机会一直占用一部分信道资源；
* 但由于计算机数据的突发性质，通信过程中没必要一直占用信道资源而不让出给其它用户使用，因此这两种方式对信道的利用率都不高；

# 四、CSMA/CD协议
* 全双工通信；
* 载波监听多点接入/碰撞检测；
* 发送流程：先听后发-边听边发-冲突停止-延退重发；
* 最短帧长：64字节；
* 所有小于64字节的帧都是由于冲突而异常中止的无效帧；
* 最短有效帧长：争用期 x 数据传输速度；
* 争用期： 2 x 端到端的传播时延t；
* 端到端的传播时延：t = 总线长度/传输速率；
* 只有经过争用期之后还没有检测到碰撞，才能肯定这次发送不会发生碰撞；
* 当发生碰撞时，站点咬停止发送，等待一段时间再发送，这个时间采用**截断二进制指数退避算法**来决定；
* 从离散的整数集合中随机取出一个数记作r，然后取r倍的争用期作为重传等待时间；
![Screenshot 2020-06-18 at 13.50.42](media/15924563355418/Screenshot%202020-06-18%20at%2013.50.42.png)


## 1. 载波监听
* 每个主机都必须不停的监听信道；
* 在发送前，如果监听到信道正在使用，就必须等待；

## 2. 多点接入
* 说明这是总线型网络；
* 许多主机以多点的方式连接到总线上；

## 3. 碰撞检测
* 在发送中，如果监听到信道已有其它主机正在发送数据，就表示发生了碰撞；
* 虽然每个主机在发送数据之前都已经监听到信道为空闲，但是由于电磁波的传播时延的存在，还是可能会发生碰撞；

# 五、PPP协议
互联网用户通常需要连接到某个ISP之后才能接入到互联网，PPP协议是用户计算机和ISP进行通信时所需要的数据链路层协议；
## 1. PPP协议组成
* 一个将IP数据报封装到串行链路的方法；
* 链路控制协议LCP;
* 网络控制协议NCP;

## 2. 帧格式
* F: 定界符；
* A/C: 暂时无意义；
* FCS: 使用CRC的检验序列；
![IMG_4756](media/15924563355418/IMG_4756.jpg)
![Screenshot 2020-06-18 at 14.00.57](media/15924563355418/Screenshot%202020-06-18%20at%2014.00.57.png)

# 六、MAC地址
* 一台主机拥有多少个网络适配器就有多少个MAC地址；
* 例如笔记本普遍有无线网络适配器和有线网络适配器，因此就有两个MAC地址；
* MAC地址是链路层地址，长度为6字节（48位）；
* 用于唯一标识网络适配器（网卡）；

# 七、局域网
* 一种典型的广播信道；
* 主要特点是网络为一个单位所拥有，且地理范围和站点数目均有限；
* 主要有[以太网](#八、以太网)等；
* 可以按照网络拓扑结构对局域网进行分类：
![Screenshot 2020-06-18 at 14.06.30](media/15924563355418/Screenshot%202020-06-18%20at%2014.06.30.png)

# 八、以太网
* 星型拓扑结构局域网；
* 采用较为灵活的无连接的工作方式；
* 发送的数据都是使用曼彻斯特编码的信号；
* 半双工通信；
* 使用交换机自学习功能；

## 1. 以太网交换机自学习功能
* 一种链路层设备；
* 不会发生碰撞，能根据MAC地址进行存储转发；
* 学习的是交换表的内容；
* 交换表中存储着MAC地址到接口的映射；
* 即插即用，不需要网络管理员手动配置交换表内容；
* 源地址收到帧栈有无匹配：有则更新，无则加；
* 转发帧找收到帧目的地址匹配：有则转发，无则除了这一个其它所有的都转发，一对一的话就丢弃；
![Screenshot 2020-06-18 at 14.18.47](media/15924563355418/Screenshot%202020-06-18%20at%2014.18.47.png)


## 2. 以太网帧格式/MAC帧格式
* 类型：标记上层使用的协议；
* 数据：如果太小需要填充，最小帧长64字节，收尾部18字节，数据部分最小字节则64-18=46；
* FCS：帧检验序列，使用CRC检验方法；
![Screenshot 2020-06-18 at 14.16.36](media/15924563355418/Screenshot%202020-06-18%20at%2014.16.36.png)

# 九、虚拟局域网
* 可以建立与物理位置无关的逻辑组；
* 只有在同一个虚拟局域网中的成员才会收到链路层广播信息；
* VLAN: 由一些局域网网段构成的与物理位置无关的逻辑组；
![Screenshot 2020-06-18 at 14.20.55](media/15924563355418/Screenshot%202020-06-18%20at%2014.20.55.png)










