# 概述
* 网络层是整个互联网的核心，因此应当让网络层尽可能简单；
* 网络层向上只提供简单灵活的、无连接的、尽最大努力交互的数据报服务；
* 使用IP协议，可以把异构的物理网络连接起来，使得在网络层看起来好像是一个统一的网络；
* 与 IP协议配套使用的还有三个协议：
  * ARP: Address Resolution Protocol; 
  * ICMP: Internet Control Message Protocol;
  * IGMP: Internet Group Management Protocol;

# 路由器在网络互联中的作用：
* 在互联网上转发分组时，是从一个路由器转发到下一个路由器；
* 在路由表中，对每一条路由最主要的是以下两个信息：**目的网络地址**，**下一跳地址**；

# 直接交付与间接交付
* 直接交付：A -> B；
* 间接交付：A -> 路由器 -> B；

# IP数据报格式
![IP数据报格式](media/15928721025215/IP%E6%95%B0%E6%8D%AE%E6%8A%A5%E6%A0%BC%E5%BC%8F.png)
* 版本： 有4（IPv4）和6（IPv6）两个值；
* 首部长度：占4位，因此最大值为15。值为1表示的是1个32位字的长度，即4字节。因为固定部分长度为20字节，因此首部长度的值最小为5，如果可选字段的长度不是4字节的整数倍，就用尾部的填充部分来填充；
* 区分服务：用来获得更好的服务，一般情况不使用；
* 总长度 = 首部 + 数据之和 = 分片后的分片首部长度与该分片的数据长度的总和 = 16位 => IP数据报最大长度是 2^16 - 1;
* 标识：在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符；
* 标志占三位但只有两位有意义：X  DF（=0，允许分片）  MF（=1，后面还有分片）；
* 片偏移：和标识符一起，用于发生分片的情况，表示某片在原分组中的相对位置，片偏移的单位为8字节；
![数据报的分片举例](media/15928721025215/%E6%95%B0%E6%8D%AE%E6%8A%A5%E7%9A%84%E5%88%86%E7%89%87%E4%B8%BE%E4%BE%8B.png)

* 生存时间TTL：防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，当TTL为0时就丢弃该数据报；
* 协议：指出携带的数据应该上交给哪个协议进行处理，如ICMP, TCP, UDP等；
* 首部检验和：因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量；
* IP数据报 = 首部 + 数据部分；
* 首部 = 固定部分（20字节） +  可选部分；

# IP地址编址方式
经历了三个历史阶段：分类，子网划分，无分类。
## 分类
* 给互联网上的每一台主机或（路由器）的每一个接口分配一个在全世界范围内是唯一的32位的标识符；
* 标志着一台主机（或路由器）和一条链路的接口；
* IP地址::={<网络号>, <主机号>}
![分类的IP地址](media/15928721025215/%E5%88%86%E7%B1%BB%E7%9A%84IP%E5%9C%B0%E5%9D%80.jpg)

## 子网划分
* 通过在主机号字段中拿一部分作为子网号，把两级IP地址划分为三级IP地址；
* IP地址::={<网络号>, <子网号>, <主机号>}；
* 外部网络看不到子网的存在；
* 要使用子网必须配置子网掩码；
* 子网号全0全1不能使用；
* 同样的IP地址和不同子网掩码可能得到相同的网络地址，但不同掩码的效果不同；
* 子网划分后，路由器必含：目的网络地址，子网掩码，下一跳地址；
* 一个B类地址的默认子网掩码为255.255.0.0；
![子网划分](media/15928721025215/%E5%AD%90%E7%BD%91%E5%88%92%E5%88%86.jpg)

## 无分类CIDR
* IP地址::={<网络前缀号>,<主机号>}
* 记法采用在IP地址后面加上网络前缀长度的方法；
* 例如：192.199.170.82/27表示前27位为网络前缀，剩下5位是主机号，含有2^5个IP地址，该地址块最小地址是192.199.170.64，最大地址是192.199.170.95；
* 将网络前缀相同的连续IP地址组成一个CIDR地址块；
* 在路由表中的项目由“网络前缀“和”下一跳地址“组成，在查找时可能会得到不止一个匹配结果，应当采用最长前缀匹配来确定应该匹配哪一个；
* 一个CIDR地址块中有很多地址，一个CIDR表示的网络就可以表示原来的很多个网络，并且在路由表中只需要一个路由就可以代替原来的多个路由，减少了路由表项的数量。把这种通过使用网络前缀来减少路由表项的方式称为路由聚合，也称为构成超网；
* CIDR的地址掩码可以继续称为子网掩码，子网掩码中1的个数是网络前缀的长度；

# 地址解析协议ARP
* 网络层实现主机之间的通信，而数据链路层实现具体每段链路之间的通信，因此在通信过程中，IP数据报的源地址和目的地址始终不变，而MAC地址随着链路的改变而改变；
![网络层实现主机之间的通信](media/15928721025215/%E7%BD%91%E7%BB%9C%E5%B1%82%E5%AE%9E%E7%8E%B0%E4%B8%BB%E6%9C%BA%E4%B9%8B%E9%97%B4%E7%9A%84%E9%80%9A%E4%BF%A1.png)
* IP协议使用ARP协议，将从网络上得到的IP地址解析成数据链路层使用的MAC地址（硬件地址）；
![ARP实现由IP地址得到MAC地址](media/15928721025215/ARP%E5%AE%9E%E7%8E%B0%E7%94%B1IP%E5%9C%B0%E5%9D%80%E5%BE%97%E5%88%B0MAC%E5%9C%B0%E5%9D%80.png)
* 原理：每一个主机都有一个ARP高速缓存，里面存放本局域网上各主机和路由器的IP地址到MAC地址（硬件地址）的映射表，并且该映射表还经常动态更新（新增或超时删除）；
* 作用范围：解决同一个局域网上的主机或路由器的IP地址和硬件地址映射的问题（自动进行）；
* ARP请求分组是广播发送的，但ARP响应分组是普通的单播；
![ARP工作原理](media/15928721025215/ARP%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.png)

# ICMP
* 网际控制报文协议是为了更有效转发IP数据报和提高交付成功的机会；
* 封装在IP数据报中，但不属于高层协议；
![ICMP报文的格式](media/15928721025215/ICMP%E6%8A%A5%E6%96%87%E7%9A%84%E6%A0%BC%E5%BC%8F.jpg)
* 种类：差错报告报文，询问报文；
![ICMP报文种类](media/15928721025215/ICMP%E6%8A%A5%E6%96%87%E7%A7%8D%E7%B1%BB.png)
* 应用：
    * Ping：分组网间探测，测试两台主机之间的连通性（通过向目的主机发送请求ICMP Echo报文，目的主机收到后会发送Echo回答报文，Ping根据时间和成功响应的次数估算出数据包往返时间和丢包率）；
    * Traceroute：跟踪一个分组从源点到终点的路径（发送的IP数据报封装的是无法交付的UDP用户数据报，并由目的主机发送终点不可达差错报告报文）；



